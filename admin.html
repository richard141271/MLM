<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLM Pro - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>

    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">MLM Admin Panel</a>
            <a href="index.html" class="btn btn-outline-light btn-sm">Tilbake til Dashboard</a>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="row">
            <div class="col-md-6">
                <div class="card p-4">
                    <h4>Provisjonsinnstillinger (5 Ledd)</h4>
                    <p class="text-muted">Angi prosentandel for hvert nivå oppover.</p>
                    <form id="settingsForm">
                        <div class="input-group mb-2">
                            <span class="input-group-text">Nivå 1 (%)</span>
                            <input type="number" class="form-control" id="rate1" step="0.1">
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Nivå 2 (%)</span>
                            <input type="number" class="form-control" id="rate2" step="0.1">
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Nivå 3 (%)</span>
                            <input type="number" class="form-control" id="rate3" step="0.1">
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Nivå 4 (%)</span>
                            <input type="number" class="form-control" id="rate4" step="0.1">
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Nivå 5 (%)</span>
                            <input type="number" class="form-control" id="rate5" step="0.1">
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">Lagre Endringer</button>
                    </form>
                </div>

                <div class="card p-4 mt-4 border-danger">
                    <h4>Systemverktøy</h4>
                    <button class="btn btn-danger" onclick="resetSystem()">Nullstill Database (Slett alt)</button>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card p-4">
                    <h4>Alle Brukere</h4>
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Navn</th>
                                    <th>Sponsor</th>
                                    <th>Inntekt</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                <!-- Users injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        // Check Admin Auth
        const storedUser = localStorage.getItem('mlm_user');
        if (!storedUser) {
            window.location.href = 'index.html';
        }
        const currentUser = JSON.parse(storedUser);
        if (currentUser.role !== 'admin') {
            alert('Ingen tilgang');
            window.location.href = 'index.html';
        }

        // Load Settings
        const data = mlmApp.getData();
        const rates = data.settings.commissionRates;
        
        document.getElementById('rate1').value = rates[0];
        document.getElementById('rate2').value = rates[1];
        document.getElementById('rate3').value = rates[2];
        document.getElementById('rate4').value = rates[3];
        document.getElementById('rate5').value = rates[4];

        // Load Users
        const users = mlmApp.getAllUsers();
        const tbody = document.getElementById('userTableBody');
        users.forEach(u => {
            const row = `
                <tr>
                    <td><small>${u.id}</small></td>
                    <td>${u.name} <span class="badge bg-secondary">${u.role}</span></td>
                    <td>${u.sponsorId || '-'}</td>
                    <td>${u.totalEarnings.toFixed(2)}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        // Save Handler
        document.getElementById('settingsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newRates = [
                document.getElementById('rate1').value,
                document.getElementById('rate2').value,
                document.getElementById('rate3').value,
                document.getElementById('rate4').value,
                document.getElementById('rate5').value
            ];
            mlmApp.updateSettings(newRates);
            alert('Innstillinger lagret!');
        });

        function resetSystem() {
            if(confirm('ADVARSEL: Dette vil slette alle brukere og transaksjoner. Er du sikker?')) {
                mlmApp.resetSystem();
                alert('Systemet er nullstilt. Du logges nå ut.');
                localStorage.removeItem('mlm_user');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>
